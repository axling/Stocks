<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd" >
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" >
  <head>
    <title>Stocks</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="css/layout.css" type="text/css" />
    <link rel="stylesheet" href="css/menu.css" type="text/css" />
    <link rel="stylesheet" href="css/general.css" type="text/css" />
  </head>
  <body>
    <div id="pagewidth" >
      <div id="header" >
	<div id="headline">Stocks</div>
	<erl>
out(A) ->
    {ehtml, [{ul, [{class, "menu"}], 
	      [{li, [], 
		[{a, [{href, "index.yaws"}, {class, active}], [{span, [], ["Start"]}]}]},
	       {li, [], 
		[{a, [{href, "stock.yaws"}], [{span, [], ["Stocks"]}]}]}]}]}.
        </erl>
      </div>
      <div id="wrapper" class="clearfix" >
	<div id="twocols" class="clearfix"> 
	  <div id="maincol" >
	    <erl>
-include("include/mnesia_defs.hrl").
-include_lib("stdlib/include/qlc.hrl").
out(A) ->
    QueryList = yaws_api:parse_query(A),
    TrendSort = list_to_integer(proplists:get_value("trend_sort", QueryList, "3")),
    All = db_lib:e(qlc:q([{S#sec.name, S#sec.instrument, 
			   S#sec.day_trend, S#sec.week_trend,
			   S#sec.month_trend, S#sec.year_trend} ||
			     S <- db_lib:h(sec)])),
    case lists:sort(fun(A, B) when TrendSort >= 3, TrendSort =< 6 ->
			    element(TrendSort, A) > element(TrendSort, B);
		       (A, B) ->
			    element(3, A) > element(3, B)
		    end, All) of
	[] ->
	    {ehtml, [{p, [], ["No analysis available"]}]};
	Sorted ->
	    FiveBest = lists:sublist(Sorted, 5),
	    FiveWorst = lists:nthtail(length(Sorted) - 5, Sorted),
	    
	    FiveBestRows = lists:map(fun map_analysis/1, FiveBest),
	    FiveWorstRows = lists:map(fun map_analysis/1, FiveWorst),

	    {ehtml, [{table, [{class, "stock_table"}], 
		      [{tr, [], [{td, [{colspan, 5}], ["Five Best"]}]},
		       {tr, [], 
			[{th, [], ["Stock"]},
			 {th, [], ["1 Day"]},
			 {th, [], ["7 Days"]},
			 {th, [], ["30 Days"]},
			 {th, [], ["365 Days"]}]}] ++
		      FiveBestRows ++
		      [{tr, [], [{td, [{colspan, 5}], []}]},
		       {tr, [], [{td, [{colspan, 5}], ["Five Worst"]}]},
		       {tr, [], 
			[{th, [], ["Stock"]},
			 {th, [], ["1 Days"]},
			 {th, [], ["7 Days"]},
			 {th, [], ["30 Days"]},
			 {th, [], ["365 Days"]}]}] ++
		      FiveWorstRows
		     }]}
    end.

map_analysis({Name, Instrument, DayTrend, WeekTrend,
	      MonthTrend, YearTrend}) when is_number(DayTrend),
					   is_number(WeekTrend),
					   is_number(MonthTrend),
					   is_number(YearTrend)->    
    {tr, [],
     [{td, [], [{a, [{href, "stock.yaws?name=" ++ Instrument}], [Name]}]},
      {td, [], [ff(100*DayTrend)]},
      {td, [], [ff(100*WeekTrend)]},
      {td, [], [ff(100*MonthTrend)]},
      {td, [], [ff(100*YearTrend)]}]}.

ff(F) when is_float(F) ->
    f("~.2f", [F]);
ff(F) when is_integer(F) ->
    integer_to_list(F).

	</erl>
        </div>
<div id="rightcol" ></div>
	    </div> 
<div id="leftcol" ></div>
</div>
	<div id="footer" > 
	</div>
	</div>
</body>

</html>


